name: Autodev Review Fix

on:
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["Claude Code Review"]
    types: [completed]
  # Scheduled fallback: catches reviews from bot actors (e.g. Copilot) that
  # get gated by GitHub's first-time contributor approval and never execute
  # the pull_request_review trigger. Runs every 15 minutes.
  schedule:
    - cron: "*/15 * * * *"

concurrency:
  group: autodev-review-fix-${{ github.event.pull_request.number || github.event.workflow_run.pull_requests[0].number || 'scheduled' }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  review-fix:
    # Skip events triggered by bots that aren't relevant reviewers
    if: github.actor != 'vercel[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      # ── Determine action ──────────────────────────────────────────
      - name: Determine action
        id: route
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Resolve PR number based on event type
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # Scheduled poll: find open autodev PRs not in "done" phase
            PR_NUMBER=$(gh pr list --repo "${{ github.repository }}" \
              --label "autodev" --state open --json number,body \
              --jq '[.[] | select(.body | test("autodev-state") | not) // select(.body | test("\"phase\": \"done\"") | not)] | first | .number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "No actionable autodev PRs found. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            EVENT_SOURCE="schedule"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # workflow_run: get PR from the triggering workflow's pull_requests
            PR_NUMBER=$(echo '${{ toJSON(github.event.workflow_run.pull_requests) }}' \
              | jq -r '.[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "No PR associated with workflow_run. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            EVENT_SOURCE="workflow_run"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            EVENT_SOURCE="pull_request_review"
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          # Check if PR has autodev label
          HAS_AUTODEV=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" \
            --json labels --jq '[.labels[].name] | any(. == "autodev")')
          if [ "$HAS_AUTODEV" != "true" ]; then
            echo "PR #$PR_NUMBER is not an autodev PR. Skipping."
            echo "action=skip" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read phase state from PR body
          PR_BODY=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" \
            --json body --jq '.body')
          PHASE=$(echo "$PR_BODY" | grep -oP '(?<=<!-- autodev-state: ).*?(?= -->)' | jq -r '.phase // "copilot"')
          COPILOT_ITERS=$(echo "$PR_BODY" | grep -oP '(?<=<!-- autodev-state: ).*?(?= -->)' | jq -r '.copilot_iterations // 0')
          echo "phase=$PHASE" >> "$GITHUB_OUTPUT"
          echo "copilot_iterations=$COPILOT_ITERS" >> "$GITHUB_OUTPUT"

          if [ "$PHASE" = "done" ]; then
            echo "Phase is done. Skipping."
            echo "action=skip" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # For workflow_run events (Claude Code Review completed)
          if [ "$EVENT_SOURCE" = "workflow_run" ]; then
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            if [ "$CONCLUSION" != "success" ]; then
              echo "Claude Code Review did not succeed (conclusion: $CONCLUSION). Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if [ "$PHASE" = "claude" ]; then
              echo "action=claude-fix" >> "$GITHUB_OUTPUT"
            else
              echo "action=skip" >> "$GITHUB_OUTPUT"
            fi
            exit 0
          fi

          # For scheduled events: check reviews via API (no event context)
          if [ "$EVENT_SOURCE" = "schedule" ]; then
            # Get the latest review on this PR
            LATEST_REVIEW=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --jq '[.[] | select(.user.login != "github-actions[bot]")] | sort_by(.submitted_at) | last // empty')

            if [ -z "$LATEST_REVIEW" ] || [ "$LATEST_REVIEW" = "null" ]; then
              echo "No reviews found on PR #$PR_NUMBER. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            REVIEWER=$(echo "$LATEST_REVIEW" | jq -r '.user.login')
            echo "reviewer=$REVIEWER" >> "$GITHUB_OUTPUT"

            # Check if there are commits after the latest review (already processed)
            REVIEW_DATE=$(echo "$LATEST_REVIEW" | jq -r '.submitted_at')
            LATEST_COMMIT_DATE=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/commits" \
              --jq '[.[].commit.committer.date] | sort | last')

            if [[ "$LATEST_COMMIT_DATE" > "$REVIEW_DATE" ]]; then
              echo "Latest commit is newer than latest review — already processed. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Check for inline comments
            COMMENT_COUNT=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments" \
              --jq '[.[] | select(.user.login != "github-actions[bot]")] | length')

            if [ "$PHASE" = "copilot" ]; then
              HAS_FEEDBACK=false
              REVIEW_BODY=$(echo "$LATEST_REVIEW" | jq -r '.body // ""')
              if [ -n "$REVIEW_BODY" ] && [ "$REVIEW_BODY" != "null" ] && [ "$REVIEW_BODY" != "" ]; then
                HAS_FEEDBACK=true
              fi
              if [ "$COMMENT_COUNT" -gt 0 ]; then
                HAS_FEEDBACK=true
              fi

              if [ "$HAS_FEEDBACK" = "true" ] && [ "$COPILOT_ITERS" -lt 3 ]; then
                echo "action=copilot-fix" >> "$GITHUB_OUTPUT"
              else
                echo "action=trigger-claude" >> "$GITHUB_OUTPUT"
              fi
              exit 0
            fi

            if [ "$PHASE" = "claude" ]; then
              echo "action=claude-fix" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "Scheduled: unknown phase $PHASE. Skipping."
            echo "action=skip" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # For pull_request_review events: check reviewer identity
          REVIEWER="${{ github.event.review.user.login }}"
          REVIEW_STATE="${{ github.event.review.state }}"
          echo "reviewer=$REVIEWER" >> "$GITHUB_OUTPUT"

          if [ "$PHASE" = "copilot" ]; then
            if [ "$REVIEWER" != "copilot-pull-request-reviewer[bot]" ]; then
              echo "Copilot phase but reviewer is $REVIEWER. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            # Check if review has actionable comments
            HAS_COMMENTS=false
            REVIEW_BODY="${{ github.event.review.body }}"
            if [ -n "$REVIEW_BODY" ] && [ "$REVIEW_BODY" != "null" ]; then
              HAS_COMMENTS=true
            fi
            # Also check for inline comments on this review
            REVIEW_ID="${{ github.event.review.id }}"
            INLINE_COUNT=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews/$REVIEW_ID/comments" \
              --jq 'length' 2>/dev/null || echo "0")
            if [ "$INLINE_COUNT" -gt 0 ]; then
              HAS_COMMENTS=true
            fi

            if [ "$HAS_COMMENTS" = "true" ] && [ "$COPILOT_ITERS" -lt 3 ]; then
              echo "action=copilot-fix" >> "$GITHUB_OUTPUT"
            else
              echo "action=trigger-claude" >> "$GITHUB_OUTPUT"
            fi
            exit 0
          fi

          if [ "$PHASE" = "claude" ]; then
            if [ "$REVIEWER" = "copilot-pull-request-reviewer[bot]" ]; then
              echo "Claude phase but reviewer is Copilot. Skipping."
              echo "action=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "action=claude-fix" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Unknown phase: $PHASE. Skipping."
          echo "action=skip" >> "$GITHUB_OUTPUT"

      # ── Checkout (shared by all fix paths) ────────────────────────
      - name: Checkout PR branch
        if: steps.route.outputs.action != 'skip'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_review' && github.event.pull_request.head.ref || '' }}
          fetch-depth: 0
          token: ${{ secrets.AUTODEV_TOKEN }}

      - name: Resolve PR branch for non-review events
        if: steps.route.outputs.action != 'skip' && github.event_name != 'pull_request_review'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=$(gh pr view "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" --json headRefName --jq '.headRefName')
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"

      - name: Setup Go
        if: steps.route.outputs.action != 'skip' && steps.route.outputs.action != 'trigger-claude'
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      # ── Copilot fix path ──────────────────────────────────────────
      - name: Extract review feedback (copilot)
        if: steps.route.outputs.action == 'copilot-fix'
        id: copilot-feedback
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash scripts/autodev/parse-reviews.sh \
            "${{ steps.route.outputs.pr_number }}" > /tmp/review-feedback.txt || true

          if [ ! -s /tmp/review-feedback.txt ]; then
            echo "No actionable feedback found. Transitioning to claude phase."
            echo "override_action=trigger-claude" >> "$GITHUB_OUTPUT"
            # Note: We intentionally do NOT increment the copilot iteration counter here.
            # No actionable feedback means no fix cycle occurred, so we transition directly
            # to the Claude phase without counting it as a fix iteration.
            exit 0
          fi

          EOF_DELIM=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "REVIEW_FEEDBACK<<${EOF_DELIM}"
            cat /tmp/review-feedback.txt
            echo "${EOF_DELIM}"
          } >> "$GITHUB_ENV"

      # ============================================================
      # AGENT EXECUTION (copilot fix) — Provider: Claude via claude-code-action@v1
      # ============================================================
      - name: Run agent (copilot fix)
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude'
        id: copilot-agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are fixing Copilot review feedback on PR #${{ steps.route.outputs.pr_number }} for the mine CLI tool.

            IMPORTANT RULES:
            - Read CLAUDE.md first for project conventions
            - Run `make test` and `make build` to verify your changes
            - Follow existing code patterns and style
            - Do NOT modify CLAUDE.md, any files in .github/workflows/, or scripts/autodev/
            - Address ALL review comments below
            - If a comment is unclear, make your best judgment

            REVIEW COMMENT REPLIES:
            After addressing each inline review comment, reply directly to it on GitHub
            for easy tracking. Each inline comment includes a `[comment_id: NNNNN]` tag.
            Use this command to reply:
              gh api "repos/${{ github.repository }}/pulls/${{ steps.route.outputs.pr_number }}/comments/{COMMENT_ID}/replies" -f body="<your reply>"
            Your reply should briefly explain what you changed to address the comment.
            If you chose not to change something, explain why.

            ## Review Feedback to Address

            ${{ env.REVIEW_FEEDBACK }}
          claude_args: "--max-turns 15 --dangerously-skip-permissions"
      # ============================================================

      - name: Handle agent failure (copilot fix)
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude' && steps.copilot-agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::warning::Copilot fix agent failed (outcome: ${{ steps.copilot-agent.outcome }}). Continuing with any partial changes."
          gh pr comment "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --body "⚠️ Autodev agent encountered an error during copilot review fix (iteration $(( ${{ steps.route.outputs.copilot_iterations }} + 1 ))). Partial changes may have been applied."

      - name: Revert protected files (copilot fix)
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude'
        run: |
          PROTECTED=$(git diff --name-only | grep -E '(CLAUDE\.md|\.github/workflows/|scripts/autodev/)' || true)
          if [ -n "$PROTECTED" ]; then
            echo "::warning::Agent modified protected files — reverting: $PROTECTED"
            echo "$PROTECTED" | xargs git checkout --
          fi

      - name: Check for changes (copilot fix)
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude'
        id: copilot-changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push (copilot fix)
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude' && steps.copilot-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          NEXT_ITER=$(( ${{ steps.route.outputs.copilot_iterations }} + 1 ))
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add -A
          git commit -m "fix: address copilot review feedback (iteration $NEXT_ITER)"
          git push

      - name: Update copilot iteration counter
        if: steps.route.outputs.action == 'copilot-fix' && steps.copilot-feedback.outputs.override_action != 'trigger-claude'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEXT_ITER=$(( ${{ steps.route.outputs.copilot_iterations }} + 1 ))
          PR_BODY=$(gh pr view "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body')

          UPDATED_BODY=$(echo "$PR_BODY" | sed \
            "s/<!-- autodev-state: [^>]* -->/<!-- autodev-state: {\"phase\": \"copilot\", \"copilot_iterations\": $NEXT_ITER} -->/")

          gh pr edit "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --body "$UPDATED_BODY"

      # ── Trigger Claude path ───────────────────────────────────────
      - name: Transition to Claude phase
        if: steps.route.outputs.action == 'trigger-claude' || steps.copilot-feedback.outputs.override_action == 'trigger-claude'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          # Update phase in PR body
          PR_BODY=$(gh pr view "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body')

          COPILOT_ITER="${{ steps.route.outputs.copilot_iterations }}"
          UPDATED_BODY=$(echo "$PR_BODY" | sed \
            "s/<!-- autodev-state: [^>]* -->/<!-- autodev-state: {\"phase\": \"claude\", \"copilot_iterations\": $COPILOT_ITER} -->/")

          gh pr edit "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --body "$UPDATED_BODY"

          # Add label to trigger Claude Code Review
          gh pr edit "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "claude-review-requested"

      # ── Claude fix path ───────────────────────────────────────────
      - name: Extract review feedback (claude)
        if: steps.route.outputs.action == 'claude-fix'
        id: claude-feedback
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash scripts/autodev/parse-reviews.sh \
            "${{ steps.route.outputs.pr_number }}" > /tmp/review-feedback.txt || true

          if [ ! -s /tmp/review-feedback.txt ]; then
            echo "No review feedback found after Claude review. Marking done."
            echo "no_feedback=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          EOF_DELIM=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "REVIEW_FEEDBACK<<${EOF_DELIM}"
            cat /tmp/review-feedback.txt
            echo "${EOF_DELIM}"
          } >> "$GITHUB_ENV"

      # ============================================================
      # AGENT EXECUTION (claude fix) — Provider: Claude via claude-code-action@v1
      # ============================================================
      - name: Run agent (claude fix)
        if: steps.route.outputs.action == 'claude-fix' && steps.claude-feedback.outputs.no_feedback != 'true'
        id: claude-agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are doing a final review-fix pass on PR #${{ steps.route.outputs.pr_number }} for the mine CLI tool.
            This is the last automated fix cycle — make it count.

            IMPORTANT RULES:
            - Read CLAUDE.md first for project conventions
            - Run `make test` and `make build` to verify your changes
            - Follow existing code patterns and style
            - Do NOT modify CLAUDE.md, any files in .github/workflows/, or scripts/autodev/
            - Address ALL review comments below
            - For anything that CANNOT be fully resolved in this PR, create a follow-up
              GitHub issue using `gh issue create` with:
              - A clear, descriptive title
              - Detailed description of what needs to be done
              - Acceptance criteria as a checkbox list
              - Reference to this PR for context

            REVIEW COMMENT REPLIES:
            After addressing each inline review comment, reply directly to it on GitHub
            for easy tracking. Each inline comment includes a `[comment_id: NNNNN]` tag.
            Use this command to reply:
              gh api "repos/${{ github.repository }}/pulls/${{ steps.route.outputs.pr_number }}/comments/{COMMENT_ID}/replies" -f body="<your reply>"
            Your reply should briefly explain what you changed to address the comment.
            If you chose not to change something, explain why.
            If you created a follow-up issue instead, include the issue link in your reply.

            ## Review Feedback to Address

            ${{ env.REVIEW_FEEDBACK }}
          claude_args: "--max-turns 15 --dangerously-skip-permissions"
      # ============================================================

      - name: Handle agent failure (claude fix)
        if: steps.route.outputs.action == 'claude-fix' && steps.claude-feedback.outputs.no_feedback != 'true' && steps.claude-agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::warning::Claude fix agent failed (outcome: ${{ steps.claude-agent.outcome }}). Continuing with any partial changes."
          gh pr comment "${{ steps.route.outputs.pr_number }}" \
            --repo "${{ github.repository }}" \
            --body "⚠️ Autodev agent encountered an error during final Claude review fix. Partial changes may have been applied. This PR may need human attention."

      - name: Revert protected files (claude fix)
        if: steps.route.outputs.action == 'claude-fix' && steps.claude-feedback.outputs.no_feedback != 'true'
        run: |
          PROTECTED=$(git diff --name-only | grep -E '(CLAUDE\.md|\.github/workflows/|scripts/autodev/)' || true)
          if [ -n "$PROTECTED" ]; then
            echo "::warning::Agent modified protected files — reverting: $PROTECTED"
            echo "$PROTECTED" | xargs git checkout --
          fi

      - name: Check for changes (claude fix)
        if: steps.route.outputs.action == 'claude-fix' && steps.claude-feedback.outputs.no_feedback != 'true'
        id: claude-changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push (claude fix)
        if: steps.route.outputs.action == 'claude-fix' && steps.claude-feedback.outputs.no_feedback != 'true' && steps.claude-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add -A
          git commit -m "fix: address claude review feedback (final pass)"
          git push

      - name: Finalize — mark phase done
        if: steps.route.outputs.action == 'claude-fix'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.route.outputs.pr_number }}"

          # Update phase to done in PR body
          PR_BODY=$(gh pr view "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body')

          COPILOT_ITER="${{ steps.route.outputs.copilot_iterations }}"
          UPDATED_BODY=$(echo "$PR_BODY" | sed \
            "s/<!-- autodev-state: [^>]* -->/<!-- autodev-state: {\"phase\": \"done\", \"copilot_iterations\": $COPILOT_ITER} -->/")

          gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "$UPDATED_BODY"

          # Remove the claude-review-requested label
          if ! gh pr edit "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --remove-label "claude-review-requested"; then
            echo "::warning::Failed to remove label 'claude-review-requested' from PR #$PR_NUMBER. The label may not exist or there may be permission/API issues."
          fi

          # Post completion comment
          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "Autodev review pipeline complete. Copilot and Claude reviews have been addressed. Ready for human merge."
