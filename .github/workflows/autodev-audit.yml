name: Autodev Audit

on:
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      limit:
        description: "Number of recent autodev PRs to audit"
        default: "10"
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: read
  id-token: write

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Generate App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      # ============================================================
      # AGENT EXECUTION — Provider: Claude via claude-code-action@v1
      # ============================================================
      - name: Run audit agent
        id: agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are auditing the autodev pipeline for the mine CLI tool.
            Your job: analyze recent autodev activity, compute a health score, detect problems,
            and produce a structured report WITH actionable follow-up issues.

            IMPORTANT RULES:
            - Read CLAUDE.md first for project conventions
            - Do NOT modify any repository files
            - Write your final report to /tmp/audit-report.md
            - Use `gh issue create --repo ${{ github.repository }}` to file actionable issues
            - Use `gh issue edit --repo ${{ github.repository }}` to clean up stale state

            ## Step 1: Gather Pipeline Data

            Fetch the last ${{ inputs.limit || '10' }} autodev PRs:

            ```bash
            gh pr list --repo ${{ github.repository }} --state all \
              --limit ${{ inputs.limit || '10' }} \
              --json number,title,state,createdAt,mergedAt,closedAt,labels,body,reviewDecision \
              --jq '[.[] | select(.labels | map(.name) | any(startswith("via/")))]'
            ```

            For each PR, extract:
            - Phase reached (from `<!-- autodev-state: ... -->` HTML comment in PR body)
            - Copilot iteration count
            - Whether `human/blocked` label was applied
            - Time from creation to merge (if merged)

            Check for stale agent/implementing issues:

            ```bash
            gh issue list --repo ${{ github.repository }} --label "agent/implementing" --state open \
              --json number,title,createdAt,labels
            ```

            Cross-reference with open autodev PRs. An `agent/implementing` issue with no
            corresponding open `via/*` PR is stale state.

            ## Step 2: Compute Pipeline Metrics and Health Score

            Calculate metrics:

            | Metric | Value |
            |--------|-------|
            | PRs analyzed | N |
            | Merged | N (%) |
            | Closed without merge | N (%) |
            | Still open | N (%) |
            | Needed human intervention (human/blocked) | N (%) |
            | Avg copilot iterations | N |
            | Avg time to merge | N hours |
            | Reached claude phase | N (%) |
            | Stale in-progress issues | N |

            **Pipeline Health Score (0–100)**:

            Start at 100, deduct points for problems:
            - Each human/blocked PR: -8 points
            - Merge rate < 80%: -10 points
            - Avg copilot iterations > 2: -5 points
            - Avg time to merge > 4 hours: -5 points
            - Each stale in-progress issue: -5 points
            - No PRs merged in the period: -20 points

            Add points for quality signals:
            - 100% merge rate: +5 points
            - Avg copilot iterations < 1: +5 points
            - Avg time to merge < 1 hour: +5 points

            Cap at 0–100. Include score and breakdown in report.

            **Trend comparison**: Fetch the most recent `report/pipeline-audit` issue to
            compare this period's score against the previous score:
            ```bash
            gh issue list --repo ${{ github.repository }} \
              --label "report/pipeline-audit" --state open --limit 2 \
              --json number,title,body,createdAt | jq '.[1]'
            ```
            Extract the previous health score from the issue body (if available).

            ## Step 3: Code Quality Spot-Check

            For each **merged** PR, fetch the diff and check for:

            ```bash
            gh pr diff <NUMBER> --repo ${{ github.repository }}
            ```

            - Missing tests: new functionality without `_test.go` additions
            - Missing docs: new commands/features without `site/src/content/docs/` updates
            - File size violations: any file exceeding 500 lines
            - Style issues: raw `fmt.Println` instead of `internal/ui` helpers

            Summarize findings per PR — keep it concise (1-2 lines each).

            ## Step 4: Review Feedback Themes

            For PRs with review comments, fetch and categorize:

            ```bash
            gh api repos/${{ github.repository }}/pulls/<NUMBER>/comments --jq '.[].body'
            ```

            Group into themes: testing gaps, style/formatting, architecture, documentation,
            error handling, performance. Show which themes appear most frequently.

            ## Step 5: Clean Up Stale State

            For each stale `agent/implementing` issue (found in Step 1):
            1. Post a comment explaining why the label is being removed
            2. Remove `agent/implementing` label and re-apply `backlog/ready`:

            ```bash
            gh issue comment <N> --repo ${{ github.repository }} \
              --body "**Autodev audit**: This issue has \`agent/implementing\` label but no corresponding open autodev PR, indicating the implementation workflow failed or was interrupted. Removing stale label and re-queuing as \`backlog/ready\`."
            gh issue edit <N> --repo ${{ github.repository }} \
              --remove-label "agent/implementing" --add-label "backlog/ready"
            ```

            ## Step 6: File Actionable Issues for Recommendations

            After writing your recommendations, for each **concrete and actionable** recommendation
            (not vague suggestions), create a GitHub issue:

            ```bash
            gh issue create \
              --repo ${{ github.repository }} \
              --title "[brief action title]" \
              --body "## Summary

            [Recommendation from pipeline audit — explain what and why]

            **Source**: Autodev Pipeline Audit — $(date -u +%Y-%m-%d)
            **Category**: [pipeline|code-quality|testing|documentation]

            ## Acceptance Criteria
            - [ ] [specific criterion]" \
              --label "infrastructure,backlog/needs-refinement"
            ```

            File issues ONLY for specific, actionable improvements. Do not file issues for:
            - Vague suggestions ("improve code quality")
            - Things already covered by the weekly sweep workflows
            - Problems that need human architectural decisions

            ## Step 7: Write Report

            Write the complete report to `/tmp/audit-report.md`:

            ```markdown
            # Autodev Pipeline Audit — YYYY-MM-DD

            ## Health Score: N/100 (↑/↓ N from previous)

            [brief one-line health summary]

            ## Pipeline Metrics

            <metrics table from Step 2>

            ### Concerning Patterns
            <bullet list of any red flags, or "None identified" if healthy>

            ## Code Quality

            <per-merged-PR findings from Step 3, or "All PRs passed quality checks">

            ## Review Feedback Themes

            <ranked list from Step 4, or "Insufficient data" if < 3 PRs with reviews>

            ## Stale State Cleaned

            <list of issues cleaned, or "No stale state detected">

            ## Recommendations

            <1-3 concrete improvements — include issue links for filed issues>

            ## Filed Issues

            <links to issues created in Step 6, or "None — pipeline is healthy">
            ```

            Keep the report concise — aim for a GitHub issue scannable in 2 minutes.
          claude_args: "--model claude-sonnet-4-6 --max-turns 40 --dangerously-skip-permissions"
      # ============================================================

      - name: Create audit issue
        if: steps.agent.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)

          if [ -f /tmp/audit-report.md ] && [ -s /tmp/audit-report.md ]; then
            BODY=$(cat /tmp/audit-report.md)
          else
            BODY="Audit agent completed but did not produce a report file. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          fi

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "Autodev Pipeline Audit — $DATE" \
            --body "$BODY" \
            --label "report/pipeline-audit"

      - name: Update pipeline health badge
        if: steps.agent.outcome == 'success'
        run: |
          SCORE=$(grep -oP '(?<=Health Score: )\d+(?=/100)' /tmp/audit-report.md 2>/dev/null | head -1)
          if [ -z "$SCORE" ]; then
            echo "::warning::Could not parse health score from report — skipping badge update. Expected format: 'Health Score: N/100'. Report format may have changed."
            exit 0
          fi

          if [ "$SCORE" -ge 90 ]; then COLOR="brightgreen"
          elif [ "$SCORE" -ge 70 ]; then COLOR="green"
          elif [ "$SCORE" -ge 50 ]; then COLOR="yellow"
          elif [ "$SCORE" -ge 30 ]; then COLOR="orange"
          else COLOR="red"
          fi

          printf '{\n  "schemaVersion": 1,\n  "label": "pipeline health",\n  "message": "%s/100",\n  "color": "%s"\n}\n' \
            "$SCORE" "$COLOR" > docs/internal/badge-pipeline-health.json

          git config user.name "mine-autodev[bot]"
          git config user.email "mine-autodev[bot]@users.noreply.github.com"
          git add docs/internal/badge-pipeline-health.json
          if git diff --staged --quiet; then
            echo "Badge unchanged — no commit needed."
          else
            git commit -m "chore: update pipeline health badge [skip ci]"
            git pull --rebase origin main
            git push origin main
            echo "Pipeline health badge updated: ${SCORE}/100 (${COLOR})"
          fi

      - name: Handle agent failure
        if: steps.agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "Autodev Pipeline Audit — $DATE (failed)" \
            --body "The audit agent failed to complete. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." \
            --label "report/pipeline-audit"
