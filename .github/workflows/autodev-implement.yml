name: Autodev Implement

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to implement"
        required: true
        type: string

concurrency:
  group: autodev-implement
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Read issue and prepare branch
        id: prep
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh issue view "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --json title,body)

          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          # Build branch name
          source scripts/autodev/config.sh
          SLUG=$(autodev_slugify "$TITLE")
          BRANCH="autodev/issue-${{ inputs.issue_number }}-${SLUG}"

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          # Save issue body to env var via delimiter (safe for multiline)
          EOF_DELIM=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "ISSUE_BODY<<${EOF_DELIM}"
            echo "$BODY"
            echo "${EOF_DELIM}"
          } >> "$GITHUB_ENV"

      - name: Create branch
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          BRANCH="${{ steps.prep.outputs.branch }}"
          # Delete stale remote branch if it exists (e.g. from a prior closed PR)
          if git ls-remote --exit-code origin "refs/heads/$BRANCH" >/dev/null 2>&1; then
            echo "::notice::Deleting stale remote branch: $BRANCH"
            git push origin --delete "$BRANCH" || true
          fi
          git checkout -b "$BRANCH"

      # ============================================================
      # AGENT EXECUTION — Provider: Claude via claude-code-action@v1
      # To swap providers, replace this step.
      # ============================================================
      - name: Run agent
        id: agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are implementing a feature for the mine CLI tool.

            IMPORTANT RULES:
            - Read CLAUDE.md first for project conventions
            - Run `make test` and `make build` to verify your changes
            - Follow existing code patterns and style
            - Do NOT modify CLAUDE.md, any files in .github/workflows/, or scripts/autodev/
            - You CAN and SHOULD update docs/internal/lessons-learned.md (append new L-NNN entries)
              and docs/internal/key-files.md when your changes warrant it
            - When adding or modifying features/commands, update ALL affected documentation:
              - Feature overview: site/src/content/docs/features/<feature>.md (update when capabilities change)
              - Command reference: site/src/content/docs/commands/<command>.md (update when flags/subcommands change)
              - Follow existing pages for format (YAML frontmatter, then markdown)
            - Check landing page components for stale claims when your changes affect a featured command:
              - site/src/components/FeatureTabs.tsx (feature descriptions and command examples)
              - site/src/components/TerminalDemo.tsx (animated terminal demo scripts)
              - site/src/content/docs/getting-started/quick-start.md (onboarding examples)
              - site/src/content/docs/index.mdx (top-level docs landing and high-level feature claims)
            - Write tests for new functionality
            - QUALITY GATE — Before committing, verify:
              - If the issue references a file pattern to follow, you have read it and matched it
              - Integration tests call the actual runXxx handler, not just helper functions
              - External tool tests use fake scripts in t.TempDir() (see cmd/tmux_test.go:59)
              - Error messages use ui.Accent.Render() for command suggestions (see cmd/config.go:180)
              - Invalid input errors include the expected format
              - All CLAUDE.md references in acceptance criteria are actually updated
            - Keep files under 500 lines

            ## BLOCKER PROTOCOL

            If you CANNOT implement this issue — for any reason — you MUST write a blocker
            report to `/tmp/agent-blocker.md` explaining why. This report will be posted
            as a comment on the issue so a human can unblock it.

            Common reasons to file a blocker report:
            - The issue requires manual setup (API keys, external services, infrastructure)
            - The acceptance criteria are ambiguous and you need clarification
            - The issue depends on another issue that hasn't been implemented yet
            - You don't have access to a required tool or resource
            - The scope is too large or too vague to implement confidently

            Format the report as markdown:
            ```
            **Reason**: <one-line summary>

            **Details**: <explanation of what blocked you>

            **Questions for human** (if any):
            - Question 1?
            - Question 2?

            **Suggested next steps**:
            - Step 1
            - Step 2
            ```

            Do NOT silently exit with no changes. Always either implement the feature
            OR write the blocker report. One of these two outcomes is required.

            ## Issue #${{ inputs.issue_number }}: ${{ steps.prep.outputs.title }}

            ${{ env.ISSUE_BODY }}

            ## PR Description (REQUIRED)

            After completing the implementation, you MUST write a detailed PR description
            to the file `/tmp/pr-description.md`. This is critical — the PR will use this
            as its body. Write it in markdown with the following structure:

            ```
            ## Summary

            <2-4 sentence overview of what was implemented and why>

            Closes #${{ inputs.issue_number }}

            ## Changes

            <Bulleted list of all significant changes, organized by area:>
            - **New files**: list each new file and its purpose
            - **Modified files**: list each modified file and what changed
            - **Architecture**: describe any design decisions or patterns used

            ## CLI Surface

            <If any new commands/flags were added, document them here:>
            - `mine <command>` — description
            - Flags: `--flag` — description

            ## Test Coverage

            <Describe what tests were added/modified:>
            - Unit tests for ...
            - Integration tests for ...
            - Edge cases covered: ...

            ## Acceptance Criteria

            <Check each criterion from the issue:>
            - [x] Criterion — how it was met
            - [ ] Criterion — why it was not met (if any)
            ```

            Write this file BEFORE your work is complete — it should be one of your last actions.

            ## PR Title (REQUIRED)

            Write the PR title to /tmp/pr-title.txt. It MUST use conventional commit format:
            `type: description` (lowercase type, no scope, no period).
            Valid types: feat, fix, chore, docs, refactor, test, ci.
            Derive the type from the nature of the change.
            Example: feat: add tmux layout persistence
          claude_args: "--model claude-sonnet-4-6 --max-turns 100 --dangerously-skip-permissions"
      # ============================================================

      - name: Handle agent failure
        if: steps.agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          echo "::error::Implementation agent failed. No changes were committed."
          echo "::error::See logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Read agent blocker report if it exists
          BLOCKER_MSG=""
          if [ -f /tmp/agent-blocker.md ]; then
            BLOCKER_MSG=$(cat /tmp/agent-blocker.md)
          fi

          COMMENT_BODY="⚠️ **Autodev agent failed during implementation.**

          No changes were committed. This issue has been removed from the autodev queue and needs human attention.

          [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          if [ -n "$BLOCKER_MSG" ]; then
            COMMENT_BODY="${COMMENT_BODY}

          ### Agent Blocker Report
          ${BLOCKER_MSG}"
          fi

          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body "$COMMENT_BODY"
          gh issue edit "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "human/blocked" \
            --remove-label "agent/implementing,backlog/ready"

      - name: Revert protected file changes
        if: steps.agent.outcome == 'success'
        run: |
          PROTECTED=$(git diff --name-only | grep -E '(CLAUDE\.md|\.github/workflows/|scripts/autodev/)' || true)
          if [ -n "$PROTECTED" ]; then
            echo "::warning::Agent modified protected files — reverting: $PROTECTED"
            echo "$PROTECTED" | xargs git checkout --
          fi

      - name: Check for changes
        if: steps.agent.outcome == 'success'
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add -A
          git commit -m "feat: implement #${{ inputs.issue_number }}" || true
          git push -u origin "${{ steps.prep.outputs.branch }}"

      - name: Create PR
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          PR_URL=$(bash scripts/autodev/open-pr.sh \
            "${{ inputs.issue_number }}" \
            "${{ steps.prep.outputs.branch }}")

          # Extract PR number from URL (e.g., https://github.com/rnwolfe/mine/pull/182)
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '/pull/\K\d+')
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      # ── Chain to review pipeline ──────────────────────────────────
      # Bypasses the pull_request_review trigger which gets gated by
      # GitHub's first-time contributor approval for bot actors (Copilot)
      # on public repos. Polls for Copilot review, then dispatches
      # review-fix directly.
      - name: Wait for review and trigger review pipeline
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'true' && steps.create-pr.outputs.pr_number
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          echo "Waiting for Copilot review on PR #$PR_NUMBER..."

          # Poll for up to 10 minutes (60 x 10s)
          for i in $(seq 1 60); do
            REVIEW_COUNT=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
              --jq '[.[] | select(.user.login != "github-actions[bot]")] | length' 2>/dev/null || echo "0")

            if [ "$REVIEW_COUNT" -gt 0 ]; then
              echo "Review found after ~$((i * 10))s. Dispatching review-fix pipeline."
              gh workflow run autodev-review-fix.yml \
                --repo "${{ github.repository }}" \
                -f pr_number="$PR_NUMBER"
              echo "Review-fix pipeline dispatched for PR #$PR_NUMBER."
              exit 0
            fi

            sleep 10
          done

          echo "::warning::No review appeared within 10 minutes. Review pipeline will rely on scheduled fallback."

      - name: Handle no changes
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          # Read agent blocker report if it exists
          BLOCKER_MSG=""
          if [ -f /tmp/agent-blocker.md ]; then
            BLOCKER_MSG=$(cat /tmp/agent-blocker.md)
          fi

          COMMENT_BODY="⚠️ **Autodev agent produced no changes.**

          The agent ran but did not modify any files. This issue has been removed from the autodev queue and needs human attention.

          [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          if [ -n "$BLOCKER_MSG" ]; then
            COMMENT_BODY="${COMMENT_BODY}

          ### Agent Blocker Report
          ${BLOCKER_MSG}"
          fi

          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body "$COMMENT_BODY"

          gh issue edit "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "human/blocked" \
            --remove-label "agent/implementing,backlog/ready"
