name: Autodev Implement

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to implement"
        required: true
        type: string

concurrency:
  group: autodev-implement
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Read issue and prepare branch
        id: prep
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_JSON=$(gh issue view "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --json title,body)

          TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          # Build branch name
          source scripts/autodev/config.sh
          SLUG=$(autodev_slugify "$TITLE")
          BRANCH="autodev/issue-${{ inputs.issue_number }}-${SLUG}"

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          # Save issue body to env var via delimiter (safe for multiline)
          EOF_DELIM=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          {
            echo "ISSUE_BODY<<${EOF_DELIM}"
            echo "$BODY"
            echo "${EOF_DELIM}"
          } >> "$GITHUB_ENV"

      - name: Create branch
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          BRANCH="${{ steps.prep.outputs.branch }}"
          # Delete stale remote branch if it exists (e.g. from a prior closed PR)
          if git ls-remote --exit-code origin "refs/heads/$BRANCH" >/dev/null 2>&1; then
            echo "::notice::Deleting stale remote branch: $BRANCH"
            git push origin --delete "$BRANCH" || true
          fi
          git checkout -b "$BRANCH"

      # ============================================================
      # AGENT EXECUTION — Provider: Claude via claude-code-action@v1
      # To swap providers, replace this step.
      # ============================================================
      - name: Run agent
        id: agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are implementing a feature for the mine CLI tool.

            IMPORTANT RULES:
            - Read CLAUDE.md first for project conventions
            - Run `make test` and `make build` to verify your changes
            - Follow existing code patterns and style
            - Do NOT modify CLAUDE.md, any files in .github/workflows/, or scripts/autodev/
            - You CAN and SHOULD update docs/internal/lessons-learned.md (append new L-NNN entries)
              and docs/internal/key-files.md when your changes warrant it
            - When adding new commands or features, create/update documentation:
              - Feature overview: site/src/content/docs/features/<feature>.md
              - Command reference: site/src/content/docs/commands/<command>.md
              - Follow existing pages for format (YAML frontmatter, then markdown)
            - Write tests for new functionality
            - Keep files under 500 lines

            ## Issue #${{ inputs.issue_number }}: ${{ steps.prep.outputs.title }}

            ${{ env.ISSUE_BODY }}

            ## PR Description (REQUIRED)

            After completing the implementation, you MUST write a detailed PR description
            to the file `/tmp/pr-description.md`. This is critical — the PR will use this
            as its body. Write it in markdown with the following structure:

            ```
            ## Summary

            <2-4 sentence overview of what was implemented and why>

            Closes #${{ inputs.issue_number }}

            ## Changes

            <Bulleted list of all significant changes, organized by area:>
            - **New files**: list each new file and its purpose
            - **Modified files**: list each modified file and what changed
            - **Architecture**: describe any design decisions or patterns used

            ## CLI Surface

            <If any new commands/flags were added, document them here:>
            - `mine <command>` — description
            - Flags: `--flag` — description

            ## Test Coverage

            <Describe what tests were added/modified:>
            - Unit tests for ...
            - Integration tests for ...
            - Edge cases covered: ...

            ## Acceptance Criteria

            <Check each criterion from the issue:>
            - [x] Criterion — how it was met
            - [ ] Criterion — why it was not met (if any)
            ```

            Write this file BEFORE your work is complete — it should be one of your last actions.

            ## PR Title (REQUIRED)

            Write the PR title to /tmp/pr-title.txt. It MUST use conventional commit format:
            `type: description` (lowercase type, no scope, no period).
            Valid types: feat, fix, chore, docs, refactor, test, ci.
            Derive the type from the nature of the change.
            Example: feat: add tmux layout persistence
          claude_args: "--model claude-sonnet-4-6 --max-turns 100 --dangerously-skip-permissions"
      # ============================================================

      - name: Handle agent failure
        if: steps.agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          echo "::error::Implementation agent failed. No changes were committed."
          echo "::error::See logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body "⚠️ Autodev agent failed during implementation. No changes were committed. This issue needs human attention. [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          gh issue edit "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "human/blocked" \
            --remove-label "agent/implementing"

      - name: Revert protected file changes
        if: steps.agent.outcome == 'success'
        run: |
          PROTECTED=$(git diff --name-only | grep -E '(CLAUDE\.md|\.github/workflows/|scripts/autodev/)' || true)
          if [ -n "$PROTECTED" ]; then
            echo "::warning::Agent modified protected files — reverting: $PROTECTED"
            echo "$PROTECTED" | xargs git checkout --
          fi

      - name: Check for changes
        if: steps.agent.outcome == 'success'
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add -A
          git commit -m "feat: implement #${{ inputs.issue_number }}" || true
          git push -u origin "${{ steps.prep.outputs.branch }}"

      - name: Create PR
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTODEV_TOKEN }}
        run: |
          bash scripts/autodev/open-pr.sh \
            "${{ inputs.issue_number }}" \
            "${{ steps.prep.outputs.branch }}"

      - name: Handle no changes
        if: steps.agent.outcome == 'success' && steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body "Autodev attempted implementation but produced no changes. This issue may need human attention."

          gh issue edit "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --add-label "human/blocked" \
            --remove-label "agent/implementing"
