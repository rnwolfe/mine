name: Backlog Sweep

on:
  schedule:
    - cron: "0 9 * * 2" # Tuesday 9 AM UTC
  workflow_dispatch:
    inputs:
      label_filter:
        description: "Label to filter issues (e.g. 'feature', 'enhancement', or leave empty for all)"
        required: false
        default: ""
        type: string

concurrency:
  group: backlog-sweep
  cancel-in-progress: false

permissions:
  issues: write
  id-token: write

jobs:
  sweep:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      # ============================================================
      # AGENT EXECUTION — Provider: Claude via claude-code-action@v1
      # ============================================================
      - name: Run backlog sweep agent
        id: agent
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are running an automated backlog quality sweep for the mine CLI tool.
            Label filter: "${{ inputs.label_filter || 'all open issues' }}"

            RULES:
            - Read CLAUDE.md and .claude/skills/shared/issue-quality-checklist.md first
            - Do NOT modify any repository files
            - Only interact with GitHub issues: add labels, post comments, create summary report
            - Do NOT apply backlog/ready label — only recommend it via comment
            - All GitHub operations use: --repo ${{ github.repository }}

            ## Your Task

            ### Step 1: Gather Issues

            ```bash
            gh issue list --repo ${{ github.repository }} --state open \
              --json number,title,body,labels,createdAt \
              --limit 100 \
              ${{ inputs.label_filter != '' && format('--label "{0}"', inputs.label_filter) || '' }}
            ```

            Filter out: issues with labels report/*, agent/*, human/blocked, release/proposal
            (these are system issues, not backlog items to curate)

            ### Step 2: Score Each Issue

            For each backlog issue, score it against the 10-item quality checklist:
            1. Summary — clear one-paragraph explanation
            2. Scope — subcommands/features enumerated
            3. Architecture — domain package, storage, key decisions
            4. Integration — connections to existing features
            5. Acceptance criteria — specific, testable checkboxes
            6. Edge cases — error handling and failure modes
            7. Tests — test requirements in criteria
            8. Documentation — doc requirements with file paths
            9. CLAUDE.md — update requirement noted if needed
            10. Labels — appropriate labels applied

            Score: count how many items are present (0-10)

            ### Step 3: Take Actions

            For each issue:

            **Score 8-10 (ready)**: Post a comment recommending backlog/ready:
            ```
            gh issue comment <N> --repo ${{ github.repository }} --body "**Backlog sweep**: This issue meets the quality bar (score: X/10). Recommend adding \`backlog/ready\` label for autonomous implementation."
            ```

            **Score 4-7 (needs refinement)**: Apply backlog/needs-refinement label + comment listing missing items:
            ```
            gh issue edit <N> --repo ${{ github.repository }} --add-label "backlog/needs-refinement"
            gh issue comment <N> --repo ${{ github.repository }} --body "**Backlog sweep** (score: X/10): Missing checklist items:
            - [ ] Acceptance criteria: no specific testable checkboxes
            - [ ] Architecture notes: no domain package identified
            [etc]

            Use /refine-issue $N to interactively improve this issue."
            ```

            **Score 0-3 (needs spec)**: Apply backlog/needs-spec label:
            ```
            gh issue edit <N> --repo ${{ github.repository }} --add-label "backlog/needs-spec"
            gh issue comment <N> --repo ${{ github.repository }} --body "**Backlog sweep** (score: X/10): This issue needs significant work before it's implementation-ready. Consider running /product spec to create a proper spec first."
            ```

            ### Step 4: Detect Stale In-Progress Issues

            ```bash
            gh issue list --repo ${{ github.repository }} --label "agent/implementing" --state open \
              --json number,title,createdAt,labels
            ```

            For each: check if a corresponding open PR exists:
            ```bash
            gh pr list --repo ${{ github.repository }} --state open --json title,labels \
              --jq '[.[] | select(.labels | map(.name) | any(startswith("via/")))]'
            ```

            If an issue has agent/implementing but no autodev PR: post a comment and remove the label:
            ```
            gh issue comment <N> --body "**Backlog sweep**: This issue has \`agent/implementing\` label but no corresponding open autodev PR. Removing stale label — if still valid, re-add \`backlog/ready\` to re-queue."
            gh issue edit <N> --remove-label "agent/implementing" --add-label "backlog/ready"
            ```

            ### Step 5: Write Summary Report

            Write to /tmp/backlog-sweep-report.md:
            ```markdown
            ## Backlog Sweep — YYYY-MM-DD

            ### Summary
            | Status | Count |
            |--------|-------|
            | Ready (recommended backlog/ready) | N |
            | Needs refinement | N |
            | Needs spec | N |
            | Stale in-progress cleaned | N |
            | Total swept | N |

            ### Issues Recommended for backlog/ready
            - #N — Title

            ### Issues Needing Refinement
            - #N — Title (score: X/10, missing: criteria, arch)

            ### Stale State Cleaned
            - #N — Title (removed agent/implementing, re-queued)

            ### Trend
            [Compare against previous sweep if report/backlog-sweep issues exist]
            ```

            Then create a summary issue:
            ```bash
            gh issue create \
              --repo ${{ github.repository }} \
              --title "Backlog Sweep — $(date -u +%Y-%m-%d)" \
              --body "$(cat /tmp/backlog-sweep-report.md)" \
              --label "report/backlog-sweep"
            ```
          claude_args: "--model claude-sonnet-4-6 --max-turns 40 --dangerously-skip-permissions"
      # ============================================================

      - name: Handle agent failure
        if: steps.agent.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          echo "::warning::Backlog sweep agent failed — ${DATE}"
