# Implementation Plan: Issue #28 — User-local hooks (~/.config/mine/hooks/)

## Approach

Issue #28's **functional requirements are fully implemented** in the worktree at `/home/rnwolfe/dev/mine-worktrees/issue-28`. The hook discovery, filename parsing, execution pipeline, CLI commands (`mine hook list/create/test`), and comprehensive tests all exist and pass. The remaining work is **documentation**: a user-facing hook guide on the Starlight site, example hook scripts in `docs/examples/hooks/`, and CLAUDE.md updates for the agentic knowledge base. The `mine hook create` templates already contain inline comments explaining the protocol, satisfying that documentation criterion.

## Pre-existing Implementation (no changes needed)

These files are already implemented and fully tested:

- `internal/hook/hook.go` — Core types: Stage, Mode, Context, Hook, Handler (103 lines)
- `internal/hook/registry.go` — Thread-safe Registry with glob pattern matching (107 lines)
- `internal/hook/pipeline.go` — 4-stage Wrap() pipeline with flag rewrites (133 lines)
- `internal/hook/discover.go` — User hook discovery, filename parsing, script creation, dry-run test (281 lines)
- `internal/hook/exec.go` — ExecHandler: run external scripts with JSON stdin/stdout protocol (67 lines)
- `internal/hook/hook_test.go` — Tests for context, patterns, registry, chaining, notify (353 lines)
- `internal/hook/discover_test.go` — Tests for filename parsing, discovery, script creation (171 lines)
- `cmd/hook.go` — CLI: `mine hook list`, `mine hook create`, `mine hook test` (137 lines)
- `cmd/root.go` — `hook.RegisterUserHooks()` called at startup (non-fatal on error)

## Files to Create

- `site/src/content/docs/commands/hook.md` — User-facing command reference for `mine hook` (list, create, test) including filename conventions, stages, modes, examples, and the JSON protocol
- `docs/examples/hooks/todo.add.preexec.sh` — Example: auto-tag todos with a default tag if none specified
- `docs/examples/hooks/todo.done.notify.sh` — Example: fire-and-forget notification when a todo is completed (e.g., log to file, send webhook)
- `docs/examples/hooks/all-commands.notify.py` — Example: Python notify hook logging all command invocations to a file

## Files to Modify

- `CLAUDE.md` — Add hook-related key files, architecture pattern for user-local hooks, and any lessons learned
- `site/src/config/sidebar.json` — No change needed; commands are autogenerated from the `commands/` directory

## Architecture Decisions

- **No new code packages**: All functional code is complete. The only additions are Markdown documentation and example scripts.
- **Site docs location**: `site/src/content/docs/commands/hook.md` follows the existing pattern where each command family gets its own page in the `commands/` directory (alongside `todo.md`, `stash.md`, `craft.md`, etc.). The sidebar auto-generates from this directory.
- **Example scripts location**: `docs/examples/hooks/` mirrors the existing `docs/examples/plugins/` directory. Examples are reference material, not embedded in the binary.
- **No `docs/hooks.md` at root**: The issue suggests `docs/hooks.md` but the project convention puts user-facing docs in `site/src/content/docs/`. Internal docs go in `docs/internal/`. The site page is the right location for the user-facing guide.

## CLI Surface

Already implemented — no changes:

- `mine hook` / `mine hook list` — Show all discovered hooks (pattern, stage, mode)
- `mine hook create <pattern> <stage>` — Scaffold a new hook script from template
- `mine hook test <file>` — Dry-run a hook with sample JSON input

## Test Strategy

### Existing tests (all passing):
- **Context**: Creation, nil-handling, JSON round-trip serialization (5 tests)
- **Pattern matching**: Exact, wildcard, deep wildcard, negatives (8 table-driven cases)
- **Registry**: Register, resolve, unregister, has-hooks, invalid patterns (6 tests)
- **Transform chaining**: Sequential execution with output→input flow (1 test)
- **Notify parallelism**: Fire-and-forget goroutines with polling verification (2 tests)
- **Filename parsing**: All variants including error cases (8 table-driven cases)
- **Discovery**: Executable check, skip non-executable, skip invalid names, empty dir (3 tests)
- **Script creation**: Template generation, permission check, duplicate prevention (1 test)
- **Stage order**: AllStages constant verification (1 test)

### No new tests needed:
The documentation-only changes don't require additional test coverage. The existing 524 lines of tests across `hook_test.go` (353 lines) and `discover_test.go` (171 lines) comprehensively cover all acceptance criteria.

### Verification:
- Run `make test` to confirm all existing tests pass before committing documentation
- Validate that example hook scripts are syntactically correct (shellcheck for .sh, python -c for .py)

## Risks & Considerations

- **Issue references `docs/hooks.md`**: The issue says to create `docs/hooks.md` as a user-facing guide. The project convention puts user-facing docs in `site/src/content/docs/`. We'll create the site page instead, which serves the same purpose and is more discoverable. If a separate `docs/hooks.md` is needed for the agentic KB, it would go in `docs/internal/` as a spec doc.
- **Example scripts aren't runnable in CI**: The example hooks are reference material only. They demonstrate patterns but aren't tested in CI. Each will include clear comments explaining what it does and how to use it.
- **CLAUDE.md is listed as a protected file**: The autodev pipeline protects CLAUDE.md from agent modification. Since this is a Maestro-managed loop (not autodev), the CLAUDE.md update should be fine, but keep changes minimal and focused on the new hook-related key files and architecture patterns.

## Acceptance Criteria Mapping

- [x] Scripts in `~/.config/mine/hooks/` are auto-discovered and registered → `discover.go:Discover()` + `RegisterUserHooks()` called in `cmd/root.go:Execute()`
- [x] Filename convention parsed correctly (command pattern, stage, extension) → `discover.go:parseHookFilename()` with right-to-left parsing
- [x] Scripts must be executable (+x) — warn on non-executable files → `discover.go:Discover()` checks `mode & 0o111`; `discover.go:TestHook()` returns specific error with `chmod +x` hint
- [x] Wildcard patterns work in filenames (`todo.*`, `*`) → `registry.go:matchPattern()` uses `filepath.Match()`; tested in `hook_test.go:TestMatchPattern`
- [x] Transform hooks chain in alphabetical order → `registry.go:Resolve()` sorts by name; tested in `TestTransformStageChaining`
- [x] Notify hooks run in parallel, fire-and-forget → `pipeline.go:runNotifyStage()` launches goroutines; tested in `TestNotifyStageParallel`
- [x] `mine hook list` shows all discovered hooks with status → `cmd/hook.go:runHookList()`
- [x] `mine hook test` dry-runs a hook with sample Context JSON → `cmd/hook.go:runHookTest()` + `discover.go:TestHook()`
- [x] `mine hook create` scaffolds a starter script with correct template → `cmd/hook.go:runHookCreate()` + `discover.go:CreateHookScript()`
- [x] Timeout on hook execution (default 5s for transform, 30s for notify) → `hook.go:DefaultTransformTimeout/DefaultNotifyTimeout` + `exec.go:ExecHandler()` with `context.WithTimeout`
- [x] Clear error messages when hooks fail (path, exit code, stderr) → `exec.go:ExecHandler()` extracts stderr, reports timeout with duration
- [x] Tests for discovery, filename parsing, execution, chaining, and timeouts → 524 lines across `hook_test.go` and `discover_test.go`

### Documentation criteria (to implement):
- [ ] User-facing guide: how to write hooks, filename conventions, examples → `site/src/content/docs/commands/hook.md`
- [ ] 2-3 example hook scripts → `docs/examples/hooks/` (auto-tag, notify, logging)
- [ ] Update `mine hook create` templates with inline comments explaining the protocol → Already done in `discover.go:CreateHookScript()` (lines 200-231)
- [ ] Update CLAUDE.md with new architecture patterns, key files, lessons learned → Add hook entries to Key Files table and architecture patterns
